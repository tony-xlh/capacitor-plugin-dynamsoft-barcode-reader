<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dynamsoft Barcode Reader Example</title>
  <meta name="description" content="A light foundation for your next frontend project based on webpack.">
  <script src="//cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <style>
    .barcode-polygon {
      fill:rgba(85,240,40,0.5);
      stroke:green;
      stroke-width:1;
    }
    
    #closeButton {
      top: 0;
      right: 0;
      position: absolute;
      z-index: 999;
    }
</style>
</head>
<body>
  <div id="content">
    <h1>Dynamsoft Barcode Reader Example</h1>
    <p>Result:<div id="results"></div></p>
    <button type="button" onClick="startScan()" disabled>Start Scan</button>
    <input id="continuousChechBox" type="checkbox" name="options" value="continuous" checked="checked"/>Continuous Scan
    <p>This example uses the Android/iOS version of Dynamsoft Barcode Reader. You can also try <a onclick='GoToJS()' style="text-decoration:underline;">the JavaScript version</a>.</p>
  </div>
  <div class="overlay"></div>
  <div class="controls">
    <select id="cameraSelect" style="position:absolute;left:0;top:0;z-index:999;"></select>
    <select id="resolutionSelect" style="position:absolute;left:0;top:20px;z-index:999;"></select>
    <button id="closeButton" type="button" onClick="stopScan()">Close</button>
  </div>
  
  <script>
    let currentResolution = "1920x1080";
    document.getElementsByClassName("controls")[0].style.display = "none";
    window.onload = init;
    
    async function init() {
      let result = await DBR.init();
      if (result) {
        if (result.success == true) {
          document.getElementsByTagName("button")[0].disabled = "";
          loadCameras();
          loadResolutions();
          await DBR.setScanRegion({left:10,top:20,right:90,bottom:65,measuredByPercentage:1});
          return;
        }
      }
      alert("failed to initialize.");
    }

    async function loadCameras(){
      let cameraSelect = document.getElementById("cameraSelect");
      let result = await DBR.getAllCameras();
      let cameras = result.cameras;
      for (let i = 0; i < cameras.length; i++) {
        cameraSelect.appendChild(new Option(cameras[i], i));
      }
      cameraSelect.addEventListener("change", async function() {
        console.log("camera changed");
        let camSelect = document.getElementById("cameraSelect");
        await DBR.selectCamera({cameraID:camSelect.selectedOptions[0].label});
      });
    }
    
    function loadResolutions(){
      let resSelect = document.getElementById("resolutionSelect");
      resSelect.appendChild(new Option("ask 480P", 1));
      resSelect.appendChild(new Option("ask 720P", 2));
      resSelect.appendChild(new Option("ask 1080P", 3));
      resSelect.appendChild(new Option("ask 2K", 4));
      resSelect.appendChild(new Option("ask 4K", 5));
      resSelect.addEventListener("change", async function() {
        let resSelect = document.getElementById("resolutionSelect");
        let lbl = resSelect.selectedOptions[0].label;
        if (lbl.indexOf("ask") != -1) {
          await DBR.setResolution({resolution:resSelect.selectedOptions[0].value});
        }
      });
    }

    async function updateResolutionSelect(newRes){
      let resSelect = document.getElementById("resolutionSelect");
      for (let index = resSelect.options.length - 1; index >=0 ; index--) {
        let option = resSelect.options[index];
        if (option.label.indexOf("got") != -1) {
          resSelect.removeChild(option);
        }
      }
      resSelect.appendChild(new Option("got "+newRes,"got "+newRes));
      resSelect.selectedIndex = resSelect.length - 1;
    }
    
    async function startScan(){
      document.getElementById("content").style.display = "none";
      document.body.style.backgroundColor = "transparent";
      document.getElementsByClassName("controls")[0].style.display = "";
      addSVGOverlay(1920,1080);
      DBR.addListener('onPlayed', async (resResult) => {
        console.log("onPlayed");
        console.log(resResult);
        currentResolution = resResult.resolution;
        updateResolutionSelect(resResult.resolution);
      });
      DBR.addListener('onFrameRead', async (retObj) => {
        let results = retObj["results"];
        if (results.length>0) {
          let text = "";
          for (let index = 0; index < results.length; index++) {
            const result = results[index];
            text = text + result.barcodeText + "<br/>";
          }
          if (document.getElementById("continuousChechBox").checked == false){
            stopScan(text);
          }
        }
        showOverlayOnSVG(retObj);
      });

      await DBR.startScan();
      
      

      
    }

    function GoToJS(){
      window.location.href = "https://pwa.xulihang.me/barcodereader/";
    }
    
    function addSVGOverlay(width, height){
      var overlayContainer = document.getElementsByClassName("overlay")[0];
      if (overlayContainer.getElementsByTagName("svg").length>0) {
          return;
      }
      //var video = document.getElementsByClassName("dbrScanner-video")[0];
      var svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.style.top = 0;
      svg.style.left = 0;
      svg.style.position = "absolute";
      svg.style.width = "100%";
      svg.style.height = "100%";
      svg.style.zIndex = 999;
      svg.style.pointerEvents = "none";
      svg.setAttribute("viewBox","0 0 "+width+" "+height);
      overlayContainer.appendChild(svg);
    }

    function showOverlayOnSVG(scanResult){
      var overlayContainer = document.getElementsByClassName("overlay")[0];
        if (overlayContainer.getElementsByTagName("svg").length>0) {
          var svg = overlayContainer.getElementsByTagName("svg")[0];
          svg.innerHTML=""
          var results = scanResult.results;

          var frameWidth, frameHeight;
          frameWidth = currentResolution.split("x")[0]; //default is landscape
          frameHeight = currentResolution.split("x")[1];

          if (scanResult.deviceOrientation) {
            if (scanResult.deviceOrientation == "portrait") {
              frameWidth = currentResolution.split("x")[1];
              frameHeight = currentResolution.split("x")[0];
            }
          }

          console.log(frameWidth+"x"+frameHeight);
          svg.setAttribute("viewBox","0 0 "+frameWidth+" "+frameHeight);
          
          for(let i = 0; i < results.length; i++){
            var result = results[i];
            if (scanResult.frameOrientation) {
              handleRotation(result, scanResult.frameOrientation, frameWidth, frameHeight);
            }
            var points = getPointsData(result);
            var a = document.createElementNS("http://www.w3.org/2000/svg","a");
            var polygon = document.createElementNS("http://www.w3.org/2000/svg","polygon");
            polygon.setAttribute("points",points);
            polygon.setAttribute("class","barcode-polygon");

            var text = document.createElementNS("http://www.w3.org/2000/svg","text");
            text.setAttribute("x",result.x1);
            text.setAttribute("y",result.y1);
            text.setAttribute("fill","red");
            text.textContent = result.barcodeText;
            text.style.fontSize = 20;
            a.append(polygon);
            a.append(text);
            svg.append(a);
          }
      }
    }

    function handleRotation(result, rotation, frameWidth, frameHeight){
      for (let i = 1; i < 5; i++) {
        let x = result["x"+i];
        let y = result["y"+i];
        let rotatedX;
        let rotatedY;
        switch (rotation) {
          case 90:
            rotatedX = frameWidth - y;
            rotatedY = x;
            if (isFront()){ //front cam portrait
              rotatedY = frameHeight - rotatedY;
            }
            break;
          case 180:
            rotatedX = frameWidth - x;
            rotatedY = frameHeight - y;
            if (isFront()){ //front cam landscape
              rotatedX = frameWidth - rotatedX;
            }
            break;
          case 270:
            rotatedX = frameHeight - y;
            rotatedY = frameWidth - x;
            if (isFront()){ //front cam portrait
              rotatedY = frameHeight - rotatedY;
            }
            break;
          default:
            rotatedX = x;
            rotatedY = y;
            if (isFront()){ //front cam landscape
              rotatedX = frameWidth - rotatedX;
            }
        }
        result["x"+i] = rotatedX;
        result["y"+i] = rotatedY;
      }
    }

    function isFront(){
      let camSelect = document.getElementById("cameraSelect");
      let label = camSelect.selectedOptions[0].label;
      if (label.toUpperCase().indexOf("BACK") != -1) { //is back cam
        return false;
      }else{
        return true;
      }
    }

    function getPointsData(lr){
      var pointsData = lr.x1+","+lr.y1 + " ";
      pointsData = pointsData+ lr.x2+","+lr.y2 + " ";
      pointsData = pointsData+ lr.x3+","+lr.y3 + " ";
      pointsData = pointsData+ lr.x4+","+lr.y4;
      return pointsData;
    }
    
    async function stopScan(resultText){
      if (!resultText) {
          resultText = "";
      }
      document.getElementById("results").innerHTML = resultText;
      document.getElementById("content").style.display = "";
      document.body.style.backgroundColor = "white";
      document.getElementsByClassName("controls")[0].style.display = "none";
      var overlayContainer = document.getElementsByClassName("overlay")[0];
      overlayContainer.innerHTML = "";
      await DBR.stopScan();
    }
    
  </script>
</body>
</html>
