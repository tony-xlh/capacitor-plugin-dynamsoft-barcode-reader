<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dynamsoft Barcode Reader Example</title>
  <meta name="description" content="A light foundation for your next frontend project based on webpack.">
  <script src="//cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <style>
    .barcode-polygon {
      fill:rgba(85,240,40,0.5);
      stroke:green;
      stroke-width:1;
    }
    
    #closeButton {
      top: 0;
      right: 0;
      position: absolute;
      z-index: 999;
    }
</style>
</head>
<body>
  <div id="content">
    <h1>Dynamsoft Barcode Reader Example</h1>
    <p>Result:<div id="results"></div></p>
    <button type="button" onClick="startScan()">Start Scan</button>
    <input id="continuousChechBox" type="checkbox" name="options" value="continuous" checked="checked"/>Continuous Scan
    <p>This example uses the Android/iOS version of Dynamsoft Barcode Reader. You can also try <a onclick='GoToJS()' style="text-decoration:underline;">the JavaScript version</a>.</p>
  </div>
  <div class="overlay"></div>
  <div class="controls">
      <button id="closeButton" type="button" onClick="stopScan()">Close</button>
  </div>
  
  <script>
    document.getElementsByClassName("controls")[0].style.display = "none";
    async function startScan(){
      document.getElementById("content").style.display = "none";
      document.body.style.backgroundColor = "transparent";
      document.getElementsByClassName("controls")[0].style.display = "";
      addSVGOverlay(1920,1080);
      
      await DBR.startScan({});
      
      DBR.addListener('onFrameRead', async (retObj) => {
        let results = retObj["results"];
        if (results.length>0) {
          let text = "";
          for (let index = 0; index < results.length; index++) {
            const result = results[index];
            text = text + result.barcodeText + "<br/>";
          }
          if (document.getElementById("continuousChechBox").checked == false){
            stopScan(text);
          }
        }
        showOverlayOnSVG(retObj);
      });
      
    }

    function GoToJS(){
      window.location.href = "https://pwa.xulihang.me/barcodereader/";
    }
    
    function addSVGOverlay(width, height){
      var overlayContainer = document.getElementsByClassName("overlay")[0];
      if (overlayContainer.getElementsByTagName("svg").length>0) {
          return;
      }
      //var video = document.getElementsByClassName("dbrScanner-video")[0];
      var svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.style.top = 0;
      svg.style.left = 0;
      svg.style.position = "absolute";
      svg.style.width = "100%";
      svg.style.height = "100%";
      svg.style.zIndex = 999;
      svg.style.pointerEvents = "none";
      svg.setAttribute("viewBox","0 0 "+width+" "+height);
      overlayContainer.appendChild(svg);
    }

    function showOverlayOnSVG(scanResult){
      var overlayContainer = document.getElementsByClassName("overlay")[0];
        if (overlayContainer.getElementsByTagName("svg").length>0) {
          var svg = overlayContainer.getElementsByTagName("svg")[0];
          svg.innerHTML=""
          var results = scanResult.results;
          svg.setAttribute("viewBox","0 0 "+scanResult.frameWidth+" "+scanResult.frameHeight);
          for(let i = 0; i < results.length; i++){
            var result = results[i];
            var points = getPointsData(result);
            var a = document.createElementNS("http://www.w3.org/2000/svg","a");
            var polygon = document.createElementNS("http://www.w3.org/2000/svg","polygon");
            polygon.setAttribute("points",points);
            polygon.setAttribute("class","barcode-polygon");

            var text = document.createElementNS("http://www.w3.org/2000/svg","text");
            text.setAttribute("x",result.x1);
            text.setAttribute("y",result.y1);
            text.setAttribute("fill","red");
            text.textContent = result.barcodeText;
            text.style.fontSize = 20;
            a.append(polygon);
            a.append(text);
            svg.append(a);
          }
      }
    }

    function getPointsData(lr){
      var pointsData = lr.x1+","+lr.y1 + " ";
      pointsData = pointsData+ lr.x2+","+lr.y2 + " ";
      pointsData = pointsData+ lr.x3+","+lr.y3 + " ";
      pointsData = pointsData+ lr.x4+","+lr.y4;
      return pointsData;
    }
    
    async function stopScan(resultText){
      if (!resultText) {
          resultText = "";
      }
      document.getElementById("results").innerHTML = resultText;
      document.getElementById("content").style.display = "";
      document.body.style.backgroundColor = "white";
      document.getElementsByClassName("controls")[0].style.display = "none";
      var overlayContainer = document.getElementsByClassName("overlay")[0];
      overlayContainer.innerHTML = "";
      await DBR.stopScan();
    }
    
  </script>
</body>
</html>
